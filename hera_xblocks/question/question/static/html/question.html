<%
    def disable_input():
        return 'disabled' if not is_submission_allowed else ''
%>
<div class="author-block__wrapper">
    <div class="author-block__content">
        <div class="author-block__image questions-image-wrapper">
            <span class="close-image-icon hidden js-close-scaffold-btn">&times;</span>
            <div class="image-holder">
                % for img_url in img_urls:
                    <img class="question__image" src="${img_url}" alt="Question image">
                % endfor
            </div>
            <div class="scaffold_help_image hidden">
            </div>
        </div>
        <div class="author-block__question questions-wrapper">
            <div class="question__content">${description}</div>
            <form class="question-form">
                % for index, problem_type in enumerate(problem_types):
                    <div class="questions-list-item-holder">
                        % if problem_type.get('title'):
                            <p class="question-title">${problem_type['title']}</p>
                        % endif
                        % if problem_type['type'] == "text" or problem_type['type'] == "number":
                            <input
                                class="questions-list__field"
                                type="${problem_type['type']}"
                                name="${index}"
                                value="${user_answer[index][0] if user_answer else ''}"
                                ${disable_input()}/>
                        % elif problem_type['type'] == "select":
                            <select class="questions-list__select" name="${index}" ${disable_input()}>
                                <option class="questions-list__select-item" value=""> ------- </option>
                                % for option in problem_type['options']:
                                    % if option.get('title'):
                                        <% selected = 'selected' if user_answer and option['title'] in user_answer[index] else '' %>
                                        <option value="${option['title']}" ${selected}>${option['title']}</option>
                                    % endif
                                % endfor
                            </select>
                        % elif problem_type['type'] == "table":
                        <div class="table-wrapper">
                            <table>
                                <tbody>
                                <% user_answer_input_index = 0 %>
                                % if problem_type['tableData'].get('columns'):
                                    <tr>
                                        % for column in problem_type['tableData']['columns']:
                                            % if column.get('type') == 'head':
                                                <th>${column['value'].replace('!', '', 1)}</th>
                                            % elif column['value'].startswith('?'):
                                                <td>
                                                    <input
                                                        type="text"
                                                        name="${index}"
                                                        value="${user_answer[index][user_answer_input_index] if user_answer else ''}"
                                                        ${disable_input()}/>
                                                </td>
                                                <% user_answer_input_index += 1 %>
                                            % else:
                                                <td>${column['value']}</td>
                                            % endif
                                        % endfor
                                    </tr>
                                % endif
                                % if problem_type['tableData'].get('rows'):

                                % for row in problem_type['tableData']['rows']:
                                    <tr>
                                        % for idx, col in enumerate(problem_type['tableData'].get('columns')):
                                            % if row[str(idx)]['value'].startswith('?'):
                                                <td>
                                                    <input
                                                        placeholder="Enter data here"
                                                        type="text"
                                                        name="${index}"
                                                        value="${user_answer[index][user_answer_input_index] if user_answer else ''}"
                                                        ${disable_input()}/>
                                                </td>
                                                <% user_answer_input_index += 1 %>
                                            % elif row[str(idx)].get('type') == 'head':
                                                <th>${row[str(idx)]['value'].replace('!', '', 1)}</th>
                                            % else:
                                                <td>${row[str(idx)]['value']}</td>
                                            % endif
                                        % endfor
                                    </tr>
                                    % endfor
                                % endif
                                </tbody>
                            </table>
                        </div>
                        % else:
                            % for option in problem_type['options']:
                                % if option.get('title'):
                                    <% checked_flag = '' %>
                                    %if user_answer and option['title'] in user_answer[index]:
                                        <% checked_flag = 'checked' %>
                                    %endif
                                        <div class="questions-list__item">
                                            <label class="questions-list__label">
                                                <input
                                                        class="questions-list__input"
                                                        type="${problem_type['type']}"
                                                        name="${index}"
                                                        value="${option['title']}"
                                                        ${checked_flag}
                                                        ${disable_input()}
                                                />
                                                <span class="questions-list__text">
                                                        ${option['title']}
                                                    </span>
                                            </label>
                                        </div>
                                % endif
                            % endfor
                        % endif
                    </div>
                % endfor
            </form>
            <div class="scaffold-info hidden">
                <button type="button" class="author-block__btn try_again">Try Again</button>
            </div>
            <div id="${'{}-{}'.format(rephrase_name, block_id)}" class="rephrase-content" hidden>
                ${scaffolds[rephrase_name]['data'].get('content')}
            </div>
            <div id="${'{}-{}'.format(break_it_down_name, block_id)}" class="break-it-down-content" hidden>
                ${scaffolds[break_it_down_name]['data'].get('content')}
            </div>
            <div id="${'{}-{}'.format(teach_me_name, block_id)}" class="teach-me-content" hidden>
                ${scaffolds[teach_me_name]['data'].get('content')}
            </div>
        </div>
        <div class="scaffolds ${'' if is_submission_allowed and submission_counter > 0 else 'hidden'}">
            <%
            break_it_down_img_urls = ' '.join(scaffolds[break_it_down_name]['data'].get('imgUrls', []))
            teach_me_img_urls = ' '.join(scaffolds[teach_me_name]['data'].get('imgUrls', []))
            %>
            <button
                    type="button"
                    class="scaffold scaffold__btn is-rephrase js-scaffold-button"
                    data-scaffold-name="${rephrase_name}"
                    data-scaffold-class-name="is-rephrase">
                    <span class="scaffold__price ${rephrase_name}">
                        %if scaffolds[rephrase_name]['paid']:
                            &#10004
                        %else:
                            -${scaffolds[rephrase_name]['cost']}
                        %endif
                    </span>
                Rephrase
            </button>
            <button
                    type="button"
                    class="scaffold scaffold__btn is-break js-scaffold-button"
                    data-img-urls="${break_it_down_img_urls}"
                    data-scaffold-name="${break_it_down_name}"
                    data-scaffold-class-name="is-break">
                    <span class="scaffold__price ${break_it_down_name}">
                        %if scaffolds[break_it_down_name]['paid']:
                            &#10004
                        %else:
                            -${scaffolds[break_it_down_name]['cost']}
                        %endif
                    </span>
                Break It Down
            </button>
            <button
                    type="button"
                    class="scaffold scaffold__btn is-teach js-scaffold-button"
                    data-img-urls="${teach_me_img_urls}"
                    data-scaffold-name="${teach_me_name}"
                    data-scaffold-class-name="is-teach">
                    <span class="scaffold__price ${teach_me_name}">
                        %if scaffolds[teach_me_name]['paid']:
                            &#10004
                        %else:
                            -${scaffolds[teach_me_name]['cost']}
                        %endif
                    </span>
                Teach Me
            </button>
        </div>
        % if iframe_url:
            <div class="show-simulation-holder">
                <button type="button" class="btn-simulation show-simulation" data-iframe-url="${iframe_url}">Show simulation</button>
            </div>
        % endif
    </div>
    <div class="author-holder author-block__buttons">
        <span class="confidence-text info hidden"></span>
        <div class="confidence-holder">
            <input type="number" class="confidence-input hidden" min="0" max="100"/>
            <span class="confidence-text error">Please tell us how confident you are about your answer.</span>
        </div>
        <div class="feedback-holder">
            <button type="button" class="feedback-open" ${'disabled' if submission_counter == 0 else ''}></button>
            <div class="feedback-content">
                <span id="feedback-message-${block_id}">
                    %if user_answer_correct:
                        Correct!
                    %elif not is_submission_allowed:
                        ${'The correct answer is "{}". Let`s move on.'.format(correct_answers)}
                    %else:
                        Incorrect, please try again. You can ask for help first if you like.
                    %endif
                </span>
                <button type="button" class="feedback-close">
                    ×
                </button>
            </div>
        </div>
        <button type="button" class="author-block__btn skip hidden">Skip</button>
        <button type="button" class="author-block__btn submit" disabled>Submit</button>
    </div>
    <div class="simulation-overlay">
        <div class="simulation-popup">
            <div class="simulation-close-btn">&times;</div>
            <iframe src="${iframe_url}" class="simulation-iframe"></iframe>
        </div>
    </div>
    <div class="footer-controls-buttons-holder">
        <div class="footer-controls-btns">
            <button class="btn btn-prev button-previous-${block_id}">Previous</button>
            <button class="btn btn-primary button-next-${block_id}">Next</button>
        </div>
    </div>
</div>
