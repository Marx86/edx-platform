<%page expression_filter="h"/>
<%inherit file="main.html" />
<%namespace name='static' file='static_content.html'/>
<%!
from django.utils.translation import ugettext as _
from django.urls import reverse

from openedx.core.djangolib.markup import HTML, Text
%>
<%block name="head_extra_js">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-datetimepicker/2.5.20/jquery.datetimepicker.full.min.js"></script>

</%block>
<%block name="head_extra_css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-datetimepicker/2.5.20/jquery.datetimepicker.min.css"/>
</%block>

<%block name="pagetitle">${_("Manage Courses")}</%block>

<main id="main">
    <h1>
        Manage Courses
        <span class="title-tooltip">
            Keep the SHIFT key pressed and CLICK on the items to select multiple entries.
        </span>
    </h1>

    <div class="manage-courses-wrapper">
        <form method="post">
            <input type="hidden" name="csrfmiddlewaretoken" value="${ csrftoken }" />
            <div class="courses-field field courses-list">
                <div class="head">
                    <label>Filter Courses:</label>
                    <input id="courseFilter" type="text">
                </div>
                <label for="${form['courses'].id_for_label}">${form['courses'].label}:</label>
                ${form['courses'].as_widget()|h}
            </div>
            <div class="courses-field field">
                <div class="head">
                    <label>Filter Classrooms:</label>
                    <input id="classroomFilter" type="text">
                </div>
                <label for="${form['classrooms'].id_for_label}">${form['classrooms'].label}:</label>
                ${form['classrooms'].as_widget()|h}
            </div>
            <div class="students-field field">
                <div class="head">
                    <label>Filter Students:</label>
                    <input id="studentFilter" type="text">
                </div>
                <label for="${form['students'].id_for_label}">${form['students'].label}:</label>
                ${form['students'].as_widget()|h}
            </div>
            <div class="due_date-field field">
                <label for="${form['due_date'].id_for_label}">${form['due_date'].label}</label>
                ${form['due_date'].as_widget()|h}
            </div>

            % if messages:
            <ul class="messages messages-success">
                % for message in messages:
                % if message.tags:
                <li class=${ message.tags }>
                    % else:
                <li>
                    % endif
                    ${ message }
                </li>
                % endfor
            </ul>
            % endif

            % if form['courses'].errors:
            <div class="messages messages-error">
                ${form['courses'].errors.as_ul()|h}
            </div>
            % endif

            % if form['students'].errors:
            <div class="messages messages-error">
                ${form['students'].errors.as_ul()|h}
            </div>
            % endif

            % if form['due_date'].errors:
            <div class="messages messages-error">
                ${form['due_date'].errors.as_ul()|h}
            </div>
            % endif

            <div class="fields-row">
                <div class="send_to_students-field field">
                    <label for="${form['send_to_students'].id_for_label}">${form['send_to_students'].label}</label>
                    ${form['send_to_students'].as_widget()|h}
                </div>
                <div class="send_to_parents-field field">
                    <label for="${form['send_to_parents'].id_for_label}">${form['send_to_parents'].label}</label>
                    ${form['send_to_parents'].as_widget()|h}
                </div>
                <div class="send_sms-field field">
                    <label for="${form['send_sms'].id_for_label}">${form['send_sms'].label}</label>
                    ${form['send_sms'].as_widget()|h}
                </div>
            </div>
            <div class="submit-wrapper">
                <input id='submit' type="submit" value="Assign Courses">
            </div>
        </form>
    </div>

    <script type="text/javascript" src="${static.url('js/jquery.formstyler.min.js')}"></script>
    <script>
    $(function () {
        $("#id_due_date").datetimepicker({
            format: 'd/m/Y H:i',
        });

        $('.manage-courses-wrapper select, .manage-courses-wrapper input[type="checkbox"]').styler();

        var $coursesList = $("#id_courses-styler li");
        var $classroomList = $("#id_classrooms-styler li");
        var $studentList = $("#id_students-styler li");

        $(document).on('keyup', '#courseFilter', {targetList: $coursesList}, filter);
        $(document).on('keyup', '#classroomFilter', {targetList: $classroomList}, filter);
        $(document).on('keyup', '#studentFilter', studentFilter);
        $(document).on('change', '#id_classrooms', studentFilter);

        function filter(e){
            var keyword = $(this).val().toLowerCase().trim();
            var optionItemSelector = '#' + e.data.targetList.parents('.jq-select-multiple').prop('id').replace('-styler', ' option');
            e.data.targetList.each(function(){
                var itemName = $(this).text();
                var listItem = itemName.toLowerCase();
                if (keyword !== "" && listItem.substring(0, keyword.length) !== keyword){
                    $(this).hide().removeClass("selected");
                    $(optionItemSelector).filter(":contains('" + itemName + "')").prop('selected', false);
                } else {
                    $(this).show();
                }
            });
            studentFilter();
        }

        function studentFilter() {
            var selectedClassroomValues = [];
            var keyword = $("#studentFilter").val().toLowerCase().trim();
            $classroomList.filter('.selected').each(function(){
                selectedClassroomValues.push($(this).text().toLowerCase());
            });
            $("#id_students option").each(function(){
                var classroom = $(this).data('classroom').toString().toLowerCase();
                var studentName = $(this).text();
                var classroomSelected = !($.inArray(classroom, selectedClassroomValues) === -1);
                var keywordNotMatchesStudentName = keyword && studentName.substring(0, keyword.length).toLowerCase() !== keyword;
                if (selectedClassroomValues.length !== 0 && !classroomSelected || keywordNotMatchesStudentName) {
                    $studentList.filter(":contains('" + studentName + "')").hide().removeClass("selected");
                    $(this).prop('selected', false);
                } else {
                    $studentList.filter(":contains('" + studentName + "')").show();
                }
            });
        }
    });
    </script>
</main>
